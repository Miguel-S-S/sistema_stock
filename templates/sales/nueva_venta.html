{% extends 'base.html' %}

{% block title %}Nueva Venta{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    .total-display { font-size: 2.5rem; font-weight: bold; color: #198754; text-align: right; }
    .vuelto-display { font-size: 1.5rem; font-weight: bold; color: #0d6efd; text-align: right; }
    .payment-card { background-color: #f8f9fa; border-left: 5px solid #0d6efd; }
</style>
{% endblock %}

{% block content %}
<form method="post" id="ventaForm">
    {% csrf_token %}

    <div class="row">
        <div class="col-lg-8">
            <h2 class="mb-4">üí∞ Nueva Venta</h2>
            
            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <label class="form-label fw-bold">Cliente (Opcional):</label>
                    <div class="input-group">
                        {{ form.cliente }}
                        <a href="{% url 'cliente_crear' %}" target="_blank" class="btn btn-outline-success"><i class="bi bi-person-plus-fill"></i></a>
                        <button type="button" class="btn btn-outline-secondary" onclick="location.reload();"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <h5 class="mb-0">Detalle de Productos</h5>
                </div>
                <div class="card-body p-0">
                    {{ formset.management_form }}
                    <table class="table table-striped mb-0" id="tabla-productos">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th width="100">Cant.</th>
                                <th width="120" class="text-end">Precio U.</th>
                                <th width="120" class="text-end">Subtotal</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody id="formset-container">
                            {% for form in formset %}
                            <tr class="form-row">
                                <td>
                                    {{ form.producto }}
                                    {% if form.producto.errors %}<div class="text-danger small">{{ form.producto.errors.0 }}</div>{% endif %}
                                </td>
                                <td>{{ form.cantidad }}</td>
                                <td class="text-end align-middle"><span class="precio-unitario text-muted">-</span></td>
                                <td class="text-end align-middle fw-bold"><span class="subtotal-row">$0.00</span></td>
                                <td class="text-center align-middle">
                                    <div class="d-none">{{ form.DELETE }}</div>
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete-row"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="p-3">
                        <button type="button" class="btn btn-outline-primary w-100" id="add-item"><i class="bi bi-plus-circle"></i> Agregar Producto</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0 text-center">Total a Pagar</h5>
                </div>
                <div class="card-body">
                    <div class="total-display" id="gran-total">$0.00</div>
                </div>
            </div>

            <div class="card shadow-sm payment-card mb-3">
                <div class="card-header fw-bold">M√©todos de Pago</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="small text-muted">üíµ Efectivo</label>
                        {{ form.monto_efectivo }}
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">üì± Mercado Pago</label>
                        {{ form.monto_mercadopago }}
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted">üè¶ Transferencia</label>
                        {{ form.monto_transferencia }}
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">Pagado:</span>
                        <span id="total-pagado" class="fw-bold">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <span class="fw-bold fs-5">Vuelto:</span>
                        <span id="vuelto-display" class="vuelto-display">$0.00</span>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-success btn-lg w-100 py-3 shadow">
                <i class="bi bi-check-circle-fill"></i> CONFIRMAR VENTA
            </button>
        </div>
    </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // 1. OBTENER PRECIOS DEL BACKEND (JSON)
   const preciosProductos = JSON.parse('{{ precios_json|escapejs }}');

    $(document).ready(function() {
        // Inicializar Select2
        function initSelect2(el) {
            $(el).select2({ theme: "bootstrap-5", width: '100%', placeholder: "Buscar..." });
        }
        $('#id_cliente').select2({ theme: "bootstrap-5", width: '100%', allowClear: true, placeholder: "Consumidor Final" });
        $('.form-row select').each(function() { initSelect2(this); });

        // --- L√ìGICA DE C√ÅLCULO ---
        function calcularTotales() {
            let granTotal = 0;

            $('#formset-container .form-row:visible').each(function() {
                const row = $(this);
                const productId = row.find('select').val();
                const cantidad = parseFloat(row.find('input[type="number"]').val()) || 0;
                
                let precio = 0;
                if (productId && preciosProductos[productId]) {
                    precio = preciosProductos[productId];
                }

                const subtotal = precio * cantidad;
                granTotal += subtotal;

                // Actualizar UI de la fila
                row.find('.precio-unitario').text('$' + precio.toFixed(2));
                row.find('.subtotal-row').text('$' + subtotal.toFixed(2));
            });

            // Actualizar Gran Total
            $('#gran-total').text('$' + granTotal.toFixed(2));

            calcularVuelto(granTotal);
        }

        function calcularVuelto(totalVenta) {
            const efectivo = parseFloat($('#id_monto_efectivo').val()) || 0;
            const mp = parseFloat($('#id_monto_mercadopago').val()) || 0;
            const transf = parseFloat($('#id_monto_transferencia').val()) || 0;

            const totalPagado = efectivo + mp + transf;
            const diferencia = totalPagado - totalVenta;

            $('#total-pagado').text('$' + totalPagado.toFixed(2));

            const vueltoLabel = $('#vuelto-display');
            if (diferencia >= 0) {
                vueltoLabel.text('$' + diferencia.toFixed(2)).removeClass('text-danger').addClass('text-primary');
            } else {
                vueltoLabel.text('Falta: $' + Math.abs(diferencia).toFixed(2)).removeClass('text-primary').addClass('text-danger');
            }
        }

        // --- EVENTOS ---
        
        // Cuando cambia producto o cantidad
        $(document).on('change keyup', '.form-row select, .form-row input[type="number"]', function() {
            calcularTotales();
        });

        // Cuando cambia montos de pago
        $('.payment-input').on('keyup change', function() {
            // Recalculamos sin cambiar el total de venta, solo el vuelto
            // Necesitamos el total actual, lo podemos recalcular o leer del DOM (mejor recalcular por seguridad)
            calcularTotales(); 
        });

        // Agregar Fila
        $('#add-item').click(function() {
            var formIdx = $('#id_detalles-TOTAL_FORMS').val();
            var container = $('#formset-container');
            var newRow = container.find('.form-row:first').clone(false);
            
            // Limpieza Select2
            newRow.find('.select2-container').remove();
            var select = newRow.find('select');
            select.removeClass('select2-hidden-accessible').removeAttr('data-select2-id').removeAttr('aria-hidden').removeAttr('tabindex');
            select.find('option').removeAttr('data-select2-id');

            // Actualizar √≠ndices
            newRow.html(newRow.html().replace(/-0-/g, '-' + formIdx + '-'));
            newRow.find('input').val('');
            newRow.find('input[type="number"]').val(1);
            newRow.find('.precio-unitario').text('-');
            newRow.find('.subtotal-row').text('$0.00');

            container.append(newRow);
            $('#id_detalles-TOTAL_FORMS').val(parseInt(formIdx) + 1);
            initSelect2(newRow.find('select'));
        });

        // Borrar Fila
        $(document).on('click', '.btn-delete-row', function() {
            var row = $(this).closest('tr');
            var deleteInput = row.find('input[name$="-DELETE"]');
            if ($('.form-row:visible').length > 1) {
                if(deleteInput.length){ deleteInput.prop('checked', true); }
                row.hide();
                calcularTotales(); // Recalcular al borrar
            } else {
                alert("Debe haber al menos un producto.");
            }
        });

        // C√°lculo inicial al cargar
        calcularTotales();
    });
</script>
{% endblock %}